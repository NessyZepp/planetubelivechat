function x({peertubeHelpers:l},R=!1){return R?"/plugins/livechat/router":l.getBaseRouterRoute?l.getBaseRouterRoute():l.getBaseStaticRoute().replace(/\/static.*$/,"/router")}function K(l){let{registerHook:R,registerSettingsScript:k,peertubeHelpers:n}=l;R({target:"action:admin-plugin-settings.init",handler:({npmName:o})=>{if(o!=="planetubelivechat"){console.log("[peertube-plugin-livechat] Settings for ".concat(o,", not planetubelivechat. Returning."));return}console.log("[peertube-plugin-livechat] Initializing diagnostic button"),document.querySelectorAll(".peertube-plugin-livechat-launch-diagnostic").forEach(a=>{a.hasAttribute("href")||(a.setAttribute("href",x(l)+"/settings/diagnostic"),a.setAttribute("target","_blank"))}),console.log("[peertube-plugin-livechat] Initializing prosody-list-rooms button");let h=document.querySelectorAll(".peertube-plugin-livechat-prosody-list-rooms-btn");try{let a=document.querySelector("#content input[type=submit]");if(window.getComputedStyle&&a){let t=window.getComputedStyle(a);if(t.cssText!=="")h.forEach(g=>{g.style.cssText=t.cssText});else{let g=Object.values(t).reduce((v,f)=>"".concat(v).concat(f,":").concat(t.getPropertyValue(f),";"));h.forEach(v=>{v.style.cssText=g})}}}catch(a){console.error("[peertube-plugin-livechat] Failed applying styles on the \xABlist rooms\xBB button.",a)}h.forEach(a=>{a.classList.contains("peertube-plugin-livechat-prosody-list-rooms-btn-binded")||(a.classList.add("peertube-plugin-livechat-prosody-list-rooms-btn-binded"),a.onclick=async()=>{console.log("[peertube-plugin-livechat] Opening the room list...");try{document.querySelectorAll(".peertube-plugin-livechat-prosody-list-rooms-content").forEach(O=>O.remove());let t=document.createElement("div");t.classList.add("peertube-plugin-livechat-prosody-list-rooms-content"),t.textContent="...",a.after(t);let g=await fetch(x(l)+"/webchat/prosody-list-rooms",{method:"GET",headers:n.getAuthHeader()});if(!g.ok)throw new Error("Response is not ok");let f=!(await n.getSettings())["disable-channel-configuration"],_=await g.json();if(!_.ok)t.textContent=_.error,t.classList.add("peertube-plugin-livechat-error");else{let O=_.rooms.sort((e,d)=>{var u,C;let s=(u=e.lasttimestamp)!=null?u:0,y=(C=d.lasttimestamp)!=null?C:0;return s===y?e.name.localeCompare(d.name):s<y?1:-1});t.textContent="";let w=document.createElement("table");w.classList.add("peertube-plugin-livechat-prosody-list-rooms"),t.append(w);let c={RoomName:await n.translate("Room name"),RoomDescription:await n.translate("Room description"),NotFound:await n.translate("Not found"),Video:await n.translate("Video"),Channel:await n.translate("Channel"),LastActivity:await n.translate("Last activity"),channelConfiguration:await n.translate("Channel options")},p=document.createElement("tr"),N=document.createElement("th");N.textContent=c.RoomName;let T=document.createElement("th");T.textContent=c.RoomDescription;let V=document.createElement("th");V.textContent="".concat(c.Video," / ").concat(c.Channel);let S=document.createElement("th");if(S.textContent=c.LastActivity,p.append(N),p.append(T),p.append(V),p.append(S),f){let e=document.createElement("th");e.textContent=c.channelConfiguration,p.append(e)}p.append(document.createElement("th")),w.append(p),O.forEach(e=>{var M,B,D,U;let d=e.localpart,s=document.createElement("tr"),y=document.createElement("td"),u=document.createElement("a");u.textContent=e.name,u.target="_blank";let C=document.createElement("td");C.textContent=e.description;let E=document.createElement("td"),I=document.createElement("td");if(e.lasttimestamp&&typeof e.lasttimestamp=="number"){let r=new Date(e.lasttimestamp*1e3);I.textContent=r.toLocaleDateString()+" "+r.toLocaleTimeString()}let b=document.createElement("a");b.classList.add("primary-button","orange-button","peertube-button-link"),b.style.margin="5px",b.onclick=async()=>{await fetch(x(l)+"/api/promote/"+encodeURIComponent(e.jid.replace(/@.*$/,"")),{method:"PUT",headers:n.getAuthHeader()})},b.innerHTML='<svg\n                  xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 4.233 4.233"\n                >\n                  <g style="stroke-width:1.00021;stroke-miterlimit:4;stroke-dasharray:none">\n                    <path\n                    style="opacity:.998;fill:currentColor;fill-opacity:1;stroke:currentColor;stroke-width:1.17052;\n                    stroke-linecap:butt;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"\n                    d="M2.403.583V-.19a.94.94 0 0 1 .942-.943l1.962-.023 1.961.01a.94.94 0 0 1\n                    .942.942v.772S6.586 4.9 5.307 4.92C4.027 4.939 2.403.583 2.403.583Z"\n                    transform="matrix(.45208 0 0 .45208 -.526 1.335)"\n                    />\n                  </g>\n                </svg>';let P=document.createElement("td");P.append(b);let H=document.createElement("td");y.append(u),s.append(y),s.append(C),s.append(E),s.append(I),f&&s.append(H),s.append(P),w.append(s);let $=r=>{let i=document.createElement("a");i.href="/p/livechat/configuration/channel?channelId="+encodeURIComponent(r),i.textContent=c.channelConfiguration,H.append(i)};if(d.match(/^channel\.(\d+)$/)){let r="/p/livechat/room?room="+encodeURIComponent(d)+"&forcetype=1";if((M=e.channel)!=null&&M.name){u.href=r;let i=document.createElement("a");i.textContent=(D=(B=e.channel)==null?void 0:B.displayName)!=null?D:"-",i.target="_blank",i.href="/video-channels/"+e.channel.name,E.append(i)}(U=e.channel)!=null&&U.id&&$(e.channel.id)}else if(/^[a-zA-A0-9-]+$/.test(d)){let r=d,i="/p/livechat/room?room="+encodeURIComponent(r)+"&forcetype=1";fetch("/api/v1/videos/"+r,{method:"GET",headers:n.getAuthHeader()}).then(async G=>{if(!G.ok){E.textContent=c.NotFound;return}let A=await G.json();if(!A){E.textContent=c.NotFound;return}u.href=i;let L=document.createElement("a");L.textContent=A.name,L.target="_blank",L.href="/videos/watch/"+r,E.append(L),A.channel.id&&$(A.channel.id)},()=>{console.error("[peertube-plugin-livechat] Failed to retrieve video "+r)})}})}}catch(t){console.error(t),n.notifier.error(t.toString(),await n.translate("An error occured while loading data."))}})})}}),k({isSettingHidden:o=>{let m=o.setting.name;switch(m){case"prosody-c2s-port":case"prosody-c2s-interfaces":return o.formValues["prosody-c2s"]!==!0;case"prosody-s2s-port":case"prosody-s2s-interfaces":case"prosody-certificates-dir":return o.formValues["prosody-room-allow-s2s"]!==!0;case"prosody-components-port":case"prosody-components-interfaces":case"prosody-components-list":return o.formValues["prosody-components"]!==!0;case"converse-autocolors":return o.formValues["converse-theme"]!=="peertube";case"chat-per-live-video-warning":return!(o.formValues["chat-all-lives"]===!0&&o.formValues["chat-per-live-video"]===!0);case"auto-ban-anonymous-ip":return o.formValues["chat-no-anonymous"]!==!1;case"prosody-firewall-configure-button":return o.formValues["prosody-firewall-enabled"]!==!0}if(m!=null&&m.startsWith("external-auth-")){let h=m.match(/^external-auth-(\w+)-oidc-/);if(h)return o.formValues["external-auth-"+h[1]+"-oidc"]!==!0}return!1}})}export{K as register};
